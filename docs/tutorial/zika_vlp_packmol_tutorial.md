# Tutorial: Zika VLP packing — Packmol vs Warp-pack (drop-in comparison)

This is a practical, reproducible guide to build the **same packed Zika virus-like particle (VLP) protein–membrane system** described in:

> Martín Soñora, Leandro Martínez, Sergio Pantano, Matías R. Machado. *Wrapping Up Viruses at Multiscale Resolution: Optimizing PACKMOL and SIRAH Execution for Simulating the Zika Virus.* J. Chem. Inf. Model. (2021)

The original paper continues with multiscale mapping and equilibration; this tutorial focuses on **the packing stage** for the *protein envelope + two-leaflet lipid bilayer*.

**What’s new here:** you can run the exact same input files with either:
- **Packmol** (reference Fortran tool), or
- **Warp-pack** (this repo’s Rust engine) using the same `.inp` file.

Warp-pack reads the Packmol `.inp`, runs the packing, and returns a Python `PackResult`. You then export with the Rust writer.

---

## What you’re building (target system)

### Protein envelope
- Starting coordinates: **PDB 6CO8** (mature ZIKV structure at 3.1 Å)
- Full envelope: generated by applying the **BIOMT symmetry transforms** in the PDB header

### Membrane geometry
The membrane is initially a spherical bilayer shell:
- **Outer leaflet phosphate radius:** 191 Å
- **Membrane thickness:** 34 Å
- Therefore: **inner leaflet phosphate radius = 191 − 34 = 157 Å**

### Lipid composition and counts
- Lipid classes are in **6:3:1** proportion for **PC:PE:PS**, modeled as **POPC/POPE/POPS**
- Total lipids: **8400** split as:
  - **Outer leaflet:** 3600
  - **Inner leaflet:** 4800

Exact per-leaflet counts implied by 6:3:1:

| Leaflet | Total | POPC | POPE | POPS |
|---|---:|---:|---:|---:|
| Outer | 3600 | 2160 | 1080 | 360 |
| Inner | 4800 | 2880 | 1440 | 480 |

---

## Software you need

Minimum for *packing* (pick one engine or install both for comparison):
1. **Packmol >= 18.169** (reference workflow; needed if you want Packmol timings)
2. **warp-md (warp-pack)** — `pip install warp-md` (Rust engine + Python UX)
3. Lipid coordinate templates (POPC/POPE/POPS). The authors use the atomic lipid structures distributed with the SIRAH force field.

Recommended:
- Python 3 (for BIOMT expansion + centering scripts below)
- VMD or PyMOL (to inspect lipid templates and pick atom indices)

Install notes:
- Packmol is available on conda-forge (`conda install -c conda-forge packmol`) or from source.
- warp-md wheels include the Rust bindings; source installs require a Rust toolchain.

---

## Project layout (recommended)

```text
zika_pack/
  00_raw/
  01_protein/
  02_lipids/
  03_packmol/
  04_qc/
```

---

## Step 1 — Fetch the starting protein structure (PDB 6CO8)

```bash
mkdir -p zika_pack/00_raw && cd zika_pack/00_raw
curl -L -o 6co8.pdb https://files.rcsb.org/download/6CO8.pdb
```

You now have `6co8.pdb`, which typically contains an asymmetric unit plus BIOMT records.

---

## Step 2 — Build the full envelope from BIOMT

### 2A) Script: apply BIOMT matrices (pure Python)

Save as `zika_pack/01_protein/apply_biomt.py`:

```python
#!/usr/bin/env python3
"""Expand a PDB file using BIOMT matrices from REMARK 350.

Usage:
  python apply_biomt.py 6co8.pdb zika_env_full.pdb

Notes:
  - Minimal script intended for typical RCSB PDB BIOMT formatting.
  - Applies all BIOMT ops to all ATOM/HETATM records.
  - Chain IDs are recycled A..Z (PDB limitation). This is OK for packing.
"""

import re
import sys
from math import isfinite

biomt_re = re.compile(
    r"^REMARK\s+350\s+BIOMT(\d)\s+(\d+)\s+([-0-9.Ee]+)\s+([-0-9.Ee]+)\s+([-0-9.Ee]+)\s+([-0-9.Ee]+)\s*$"
)


def parse_biomt(lines):
    ops = {}
    for line in lines:
        m = biomt_re.match(line)
        if not m:
            continue
        row = int(m.group(1)) - 1
        idx = int(m.group(2))
        vals = list(map(float, m.groups()[2:]))
        if idx not in ops:
            ops[idx] = [[0.0, 0.0, 0.0, 0.0] for _ in range(3)]
        ops[idx][row] = vals

    complete = []
    for idx in sorted(ops):
        mat = ops[idx]
        if all(all(isfinite(x) for x in row) for row in mat):
            complete.append(mat)

    if not complete:
        raise RuntimeError("No BIOMT matrices found. Is this a PDB with REMARK 350 BIOMT lines?")

    return complete


def transform_xyz(mat, x, y, z):
    xp = mat[0][0] * x + mat[0][1] * y + mat[0][2] * z + mat[0][3]
    yp = mat[1][0] * x + mat[1][1] * y + mat[1][2] * z + mat[1][3]
    zp = mat[2][0] * x + mat[2][1] * y + mat[2][2] * z + mat[2][3]
    return xp, yp, zp


def main(inp, outp):
    with open(inp, "r", encoding="utf-8", errors="replace") as f:
        lines = f.readlines()

    biomts = parse_biomt(lines)
    atom_lines = [ln for ln in lines if ln.startswith(("ATOM  ", "HETATM"))]
    header = [ln for ln in lines if not ln.startswith(("ATOM  ", "HETATM"))]

    out = []
    out.extend(header)

    serial = 1
    for op_i, mat in enumerate(biomts, start=1):
        chain_tag = chr(((op_i - 1) % 26) + ord("A"))
        for ln in atom_lines:
            x = float(ln[30:38])
            y = float(ln[38:46])
            z = float(ln[46:54])
            xp, yp, zp = transform_xyz(mat, x, y, z)

            ln2 = list(ln)
            ln2[6:11] = f"{serial:5d}"
            ln2[21] = chain_tag
            ln2[30:38] = f"{xp:8.3f}"
            ln2[38:46] = f"{yp:8.3f}"
            ln2[46:54] = f"{zp:8.3f}"
            out.append("".join(ln2))
            serial += 1

    out.append("END\n")

    with open(outp, "w", encoding="utf-8") as f:
        f.writelines(out)


if __name__ == "__main__":
    if len(sys.argv) != 3:
        print("Usage: python apply_biomt.py input.pdb output.pdb", file=sys.stderr)
        sys.exit(2)
    main(sys.argv[1], sys.argv[2])
```

Run:

```bash
mkdir -p zika_pack/01_protein
python zika_pack/01_protein/apply_biomt.py zika_pack/00_raw/6co8.pdb zika_pack/01_protein/zika_env_full.pdb
```

**Sanity check:** the full envelope file should have many more atoms and chains than the asymmetric unit.

---

## Step 3 — Center the protein envelope at the origin

PACKMOL constraints are easiest when the VLP is centered at (0,0,0).

Save as `zika_pack/01_protein/center_pdb.py`:

```python
#!/usr/bin/env python3
"""Center ATOM/HETATM coordinates of a PDB at the origin."""

import sys


def main(inp, outp):
    atoms = []
    lines = []
    with open(inp) as f:
        for ln in f:
            lines.append(ln)
            if ln.startswith(("ATOM  ", "HETATM")):
                x = float(ln[30:38])
                y = float(ln[38:46])
                z = float(ln[46:54])
                atoms.append((x, y, z))

    cx = sum(a[0] for a in atoms) / len(atoms)
    cy = sum(a[1] for a in atoms) / len(atoms)
    cz = sum(a[2] for a in atoms) / len(atoms)

    out = []
    for ln in lines:
        if ln.startswith(("ATOM  ", "HETATM")):
            x = float(ln[30:38]) - cx
            y = float(ln[38:46]) - cy
            z = float(ln[46:54]) - cz
            ln2 = list(ln)
            ln2[30:38] = f"{x:8.3f}"
            ln2[38:46] = f"{y:8.3f}"
            ln2[46:54] = f"{z:8.3f}"
            out.append("".join(ln2))
        else:
            out.append(ln)

    with open(outp, "w") as f:
        f.writelines(out)


if __name__ == "__main__":
    main(sys.argv[1], sys.argv[2])
```

Run:

```bash
python zika_pack/01_protein/center_pdb.py zika_pack/01_protein/zika_env_full.pdb zika_pack/01_protein/zika_env_full_centered.pdb
```

---

## Step 4 — Gather lipid template structures (POPC/POPE/POPS)

Put one template conformation per lipid species into `zika_pack/02_lipids/`:

```text
zika_pack/02_lipids/POPC.pdb
zika_pack/02_lipids/POPE.pdb
zika_pack/02_lipids/POPS.pdb
```

### Download lipid PDBs (SIRAH bundle)

The SIRAH bundles include lipid template PDBs under `sirah_*/PDB/`. The docs describe the bundle names and folder layout. citeturn1search1turn1search0

1. Download SIRAH from the official download page (GROMACS or AMBER):
   - GROMACS release page: `https://github.com/SIRAHFF/documentation/releases/tag/GROMACS`
   - AMBER release page: `https://github.com/SIRAHFF/documentation/releases/tag/AMBER` citeturn5view0turn6view2turn6view3
2. The docs show example bundle names:
   - `sirah_x2.2_20-07.ff.tar.gz` (GROMACS)
   - `sirah_x2.3_24-07.amber.tar.gz` (AMBER) citeturn1search1turn1search0
3. Extract and copy the lipid PDBs:

```bash
tar -xzvf sirah_x2.2_20-07.ff.tar.gz
cp sirah_x2.2_20-07.ff/PDB/POPC.pdb zika_pack/02_lipids/
cp sirah_x2.2_20-07.ff/PDB/POPE.pdb zika_pack/02_lipids/
cp sirah_x2.2_20-07.ff/PDB/POPS.pdb zika_pack/02_lipids/
```

If you want a direct download command, you can use the GitHub releases API to fetch the asset by name. The SIRAH docs list the bundle filenames. citeturn4search1turn1search0turn4search0

```bash
python - <<'PY'
import json
import urllib.request

def download_release_asset(tag, filename, out_path):
    api = f"https://api.github.com/repos/SIRAHFF/documentation/releases/tags/{tag}"
    with urllib.request.urlopen(api) as resp:
        data = json.load(resp)
    url = None
    for asset in data.get("assets", []):
        if asset.get("name") == filename:
            url = asset.get("browser_download_url")
            break
    if not url:
        raise SystemExit(f"Asset {filename} not found in tag {tag}")
    print("Downloading:", url)
    urllib.request.urlretrieve(url, out_path)

download_release_asset("GROMACS", "sirah_x2.2_20-07.ff.tar.gz", "sirah_x2.2_20-07.ff.tar.gz")
download_release_asset("AMBER", "sirah_x2.3_24-07.amber.tar.gz", "sirah_x2.3_24-07.amber.tar.gz")
PY
```

### If you downloaded a bilayer (multi‑lipid) PDB

Extract a single lipid as a template:

```bash
python scripts/extract_lipid_pdb.py bilayer.pdb zika_pack/02_lipids/POPC.pdb --resname POPC
python scripts/extract_lipid_pdb.py bilayer.pdb zika_pack/02_lipids/POPE.pdb --resname POPE
python scripts/extract_lipid_pdb.py bilayer.pdb zika_pack/02_lipids/POPS.pdb --resname POPS
```

Tip: list residues first to confirm IDs:

```bash
python scripts/extract_lipid_pdb.py bilayer.pdb out.pdb --list
```

### Identify the atoms you will restrain
PACKMOL will need atom indices for:
1. a **phosphate atom** (headgroup placement on spherical shells), and
2. a **tail-tip atom** (enforces head–tail separation)

The paper’s restraint idea is:
- phosphate atoms restricted to a **2 Å-thick shell** (a “slab” in spherical geometry)
- tail tip restricted to be **at least 12 Å below phosphate** (toward bilayer center)

If you don’t know which atoms to use:
- open the lipid PDB in VMD/PyMOL and pick the phosphate and a terminal tail carbon; or
- inspect the first lines with line numbers:

```bash
nl -ba zika_pack/02_lipids/POPC.pdb | head -n 40
```

Write down the two atom indices per lipid template; you’ll plug them into the PACKMOL inputs below.

---

## Step 5 — PACKMOL strategy (two-cycle “good-compromised” workflow)

### Critical clashes (QC target)
The paper defines critical clashes as:
- **lipid–protein distances < 2.0 Å**, or
- **lipid–lipid distances < 0.21 Å**

Two packing iterations are usually enough; remaining bad lipids can be removed.

### Parameter summary (what you will run)

**Cycle 1 (pack #7):**
- `tolerance 3.0`
- `packall`, `movebadrandom`
- `maxit 40`, `nloop 100`, `movefrac 0.01`
- protein `fscale 100`
- lipids `radius 1.8`

**Cycle 2 (repack #23, restarting from cycle 1):**
- `maxit 40`, `nloop 20`, `movefrac 0.005`
- enable short-distance penalty: `use_short_tol`, `short_tol_dist 0.5`, `short_tol_scale 3`
- protein `fscale 500`

---

## Step 6 — Cycle 1 PACKMOL input (pack #7)

Create a folder:

```bash
mkdir -p zika_pack/03_packmol
```

Create `zika_pack/03_packmol/pack_cycle1.inp` with the template below.

You must edit:
1. Paths to the protein and lipid PDBs
2. Atom indices for phosphate and tail tip (search for `PHOS_ATOM_INDEX` / `TAIL_ATOM_INDEX`)

> Note: The extra broad “inside/outside sphere” constraints below are a pragmatic way to keep molecules in the right radial neighborhood. The *paper’s essential constraints* are the **phosphate shell** and the **tail-tip constraint**.

```text
# pack_cycle1.inp  (ZIKV: pack #7 first cycle)

tolerance 3.0
filetype pdb
output zika_pack_cycle1.pdb

packall
movebadrandom

maxit 40
nloop 100
movefrac 0.01

restart_to zika_pack_cycle1.restart

# --- fixed protein envelope ---
structure ../01_protein/zika_env_full_centered.pdb
  number 1
  fixed 0.0 0.0 0.0 0.0 0.0 0.0
  fscale 100
end structure

# --- geometry constants (Å) ---
# Outer phosphate: 191 Å; inner phosphate: 157 Å
# Phosphate shells are ±1 Å (2 Å total thickness)

# ---------- OUTER LEAFLET ----------
structure ../02_lipids/POPC.pdb
  number 2160
  radius 1.8

  inside sphere 0.0 0.0 0.0 210.0
  outside sphere 0.0 0.0 0.0 140.0

  atoms PHOS_ATOM_INDEX
    inside sphere 0.0 0.0 0.0 192.0
    outside sphere 0.0 0.0 0.0 190.0
  end atoms

  atoms TAIL_ATOM_INDEX
    inside sphere 0.0 0.0 0.0 179.0
  end atoms
end structure

structure ../02_lipids/POPE.pdb
  number 1080
  radius 1.8
  inside sphere 0.0 0.0 0.0 210.0
  outside sphere 0.0 0.0 0.0 140.0
  atoms PHOS_ATOM_INDEX
    inside sphere 0.0 0.0 0.0 192.0
    outside sphere 0.0 0.0 0.0 190.0
  end atoms
  atoms TAIL_ATOM_INDEX
    inside sphere 0.0 0.0 0.0 179.0
  end atoms
end structure

structure ../02_lipids/POPS.pdb
  number 360
  radius 1.8
  inside sphere 0.0 0.0 0.0 210.0
  outside sphere 0.0 0.0 0.0 140.0
  atoms PHOS_ATOM_INDEX
    inside sphere 0.0 0.0 0.0 192.0
    outside sphere 0.0 0.0 0.0 190.0
  end atoms
  atoms TAIL_ATOM_INDEX
    inside sphere 0.0 0.0 0.0 179.0
  end atoms
end structure

# ---------- INNER LEAFLET ----------
structure ../02_lipids/POPC.pdb
  number 2880
  radius 1.8

  inside sphere 0.0 0.0 0.0 200.0
  outside sphere 0.0 0.0 0.0 120.0

  atoms PHOS_ATOM_INDEX
    inside sphere 0.0 0.0 0.0 158.0
    outside sphere 0.0 0.0 0.0 156.0
  end atoms

  atoms TAIL_ATOM_INDEX
    outside sphere 0.0 0.0 0.0 169.0
  end atoms
end structure

structure ../02_lipids/POPE.pdb
  number 1440
  radius 1.8
  inside sphere 0.0 0.0 0.0 200.0
  outside sphere 0.0 0.0 0.0 120.0
  atoms PHOS_ATOM_INDEX
    inside sphere 0.0 0.0 0.0 158.0
    outside sphere 0.0 0.0 0.0 156.0
  end atoms
  atoms TAIL_ATOM_INDEX
    outside sphere 0.0 0.0 0.0 169.0
  end atoms
end structure

structure ../02_lipids/POPS.pdb
  number 480
  radius 1.8
  inside sphere 0.0 0.0 0.0 200.0
  outside sphere 0.0 0.0 0.0 120.0
  atoms PHOS_ATOM_INDEX
    inside sphere 0.0 0.0 0.0 158.0
    outside sphere 0.0 0.0 0.0 156.0
  end atoms
  atoms TAIL_ATOM_INDEX
    outside sphere 0.0 0.0 0.0 169.0
  end atoms
end structure
```

Run:

```bash
cd zika_pack/03_packmol
packmol < pack_cycle1.inp | tee pack_cycle1.log
```

Outputs:
- `zika_pack_cycle1.pdb`
- `zika_pack_cycle1.restart`

### Warp-pack (same input)

Warp-pack reads the same `.inp` and returns a `PackResult`. Export to PDB with the Rust writer:

```bash
python - <<'PY'
from warp_md.pack import parse_inp, run, export

cfg = parse_inp("zika_pack/03_packmol/pack_cycle1.inp")
result = run(cfg)
export(result, "pdb", "zika_pack/03_packmol/zika_pack_cycle1.warp.pdb")
PY
```

Outputs:
- `zika_pack_cycle1.warp.pdb`
- `zika_pack_cycle1.restart` (from `restart_to` in the `.inp`)

---

## Step 7 — Cycle 2 PACKMOL input (repack #23)

Create `zika_pack/03_packmol/pack_cycle2.inp`.

This is identical to cycle 1 except:
- `nloop 20`
- `movefrac 0.005`
- enable short-distance penalty (`use_short_tol`, `short_tol_dist 0.5`, `short_tol_scale 3`)
- `restart_from zika_pack_cycle1.restart`
- protein `fscale 500`

Template:

```text
# pack_cycle2.inp  (ZIKV: repack #23)

tolerance 3.0
filetype pdb
output zika_pack_cycle2.pdb

packall
movebadrandom

maxit 40
nloop 20
movefrac 0.005

use_short_tol
short_tol_dist 0.5
short_tol_scale 3

restart_from zika_pack_cycle1.restart
restart_to   zika_pack_cycle2.restart

structure ../01_protein/zika_env_full_centered.pdb
  number 1
  fixed 0.0 0.0 0.0 0.0 0.0 0.0
  fscale 500
end structure

# --- all lipid blocks are identical to cycle 1 ---
# Copy/paste the OUTER and INNER leaflet blocks from pack_cycle1.inp here.
```

Run:

```bash
packmol < pack_cycle2.inp | tee pack_cycle2.log
```

### Warp-pack (same input)

```bash
python - <<'PY'
from warp_md.pack import parse_inp, run, export

cfg = parse_inp("zika_pack/03_packmol/pack_cycle2.inp")
result = run(cfg)
export(result, "pdb", "zika_pack/03_packmol/zika_pack_cycle2.warp.pdb")
PY
```

---

## Packmol vs Warp-pack comparison checklist

Compare outputs side-by-side:
- **Counts:** number of atoms, residues, and lipids per leaflet.
- **Restart parity:** confirm `zika_pack_cycle1.restart` and `zika_pack_cycle2.restart` are created.
- **Min distances:** check lipid–protein and lipid–lipid minimum distances.
- **Visual sanity:** ensure no obvious punctures or inverted tails.

Suggested quick checks:

```bash
grep -c "^ATOM\\|^HETATM" zika_pack/03_packmol/zika_pack_cycle2.pdb
grep -c "^ATOM\\|^HETATM" zika_pack/03_packmol/zika_pack_cycle2.warp.pdb
```

---

## Step 8 — Quick quality control

You’re trying to eliminate (or nearly eliminate) critical clashes.

### Option A: MDAnalysis (fast “is it obviously broken?” check)

Save as `zika_pack/04_qc/qc_min_lipid_protein_dist.py`:

```python
#!/usr/bin/env python3
"""Compute the minimum lipid–protein distance for a packed PDB."""

import sys

try:
    import MDAnalysis as mda
    from MDAnalysis.lib.distances import distance_array
except ImportError:
    raise SystemExit("Install MDAnalysis first: pip install MDAnalysis")

u = mda.Universe(sys.argv[1])
protein = u.select_atoms("protein")
nonprot = u.select_atoms("not protein")

D = distance_array(nonprot.positions, protein.positions)
min_dist = D.min()
print(f"Minimum non-protein to protein distance: {min_dist:.3f} Å")
```

Run:

```bash
mkdir -p zika_pack/04_qc
python zika_pack/04_qc/qc_min_lipid_protein_dist.py zika_pack/03_packmol/zika_pack_cycle2.pdb
```

### Option B: GROMACS mindist

If you’re already using GROMACS:

```bash
gmx editconf -f zika_pack_cycle2.pdb -o zika_pack_cycle2.gro
# build an index with Protein and a lipid group, then:
gmx mindist -f zika_pack_cycle2.gro -s zika_pack_cycle2.gro -n index.ndx -group
```

---

## Step 9 — If you still have a few bad lipids

Practical procedure:
1. Identify lipids with atoms < 2.0 Å to protein.
2. Delete those lipids from the PDB.
3. (Optional) run a third repack cycle from `zika_pack_cycle2.restart`.

The paper notes that after two iterations, it’s normal to remove remaining problematic lipids.

---

## Troubleshooting

### PACKMOL runs forever / seems stuck
- Ensure you’re using **small `movefrac`** (0.01 then 0.005) and not an overly exhaustive protocol.
- Confirm `packall` and `movebadrandom` are enabled.

### Lipids invade protein cavities
- Increase protein `fscale` (cycle 2 uses 500).

### Membrane looks too thick/thin
- Double-check your phosphate and tail-tip atom indices.
- Verify outer phosphate radius (191 Å) and thickness (34 Å) are implemented as intended.

---

## Next steps (beyond this tutorial)

After packing, the paper:
- maps to coarse-grained SIRAH,
- adds multiscale solvent shells,
- equilibrates in stages (protein hydration first, then membrane), resolvating if density bubbles appear.

If you want, you can extend this guide with those steps once packing is working reliably.
