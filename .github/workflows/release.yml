name: release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      tag:
        description: "Release tag (e.g. v0.1.2)"
        required: true
        type: string

permissions:
  id-token: write
  contents: write

jobs:
  publish-cpu:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Resolve release version
        id: relver
        run: |
          TAG="${{ inputs.tag }}"
          if [ -z "$TAG" ]; then
            TAG="${GITHUB_REF_NAME}"
          fi
          VERSION="${TAG#v}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Update version files
        env:
          RELEASE_VERSION: ${{ steps.relver.outputs.version }}
        run: |
          python - <<'PY'
          import os
          import re
          from pathlib import Path

          version = os.environ["RELEASE_VERSION"]

          def update(path: Path) -> None:
            text = path.read_text()
            text = re.sub(r'(?m)^version = ".*?"$', f'version = "{version}"', text)
            path.write_text(text)

          update(Path("pyproject.toml"))
          for cargo in Path("crates").rglob("Cargo.toml"):
            update(cargo)
          PY

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Set up Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install build tools
        run: |
          python -m pip install --upgrade pip
          python -m pip install maturin==1.5.1
          python -m pip install pytest

      - name: Build CPU wheels (manylinux2014)
        uses: PyO3/maturin-action@v1
        env:
          PYO3_USE_ABI3_FORWARD_COMPATIBILITY: "1"
        with:
          command: build
          docker-options: >-
            -e PYO3_USE_ABI3_FORWARD_COMPATIBILITY=1
          args: >-
            --release
            --interpreter /opt/python/cp38-cp38/bin/python
            --interpreter /opt/python/cp39-cp39/bin/python
            --interpreter /opt/python/cp310-cp310/bin/python
            --interpreter /opt/python/cp311-cp311/bin/python
            --interpreter /opt/python/cp312-cp312/bin/python
            --interpreter /opt/python/cp313-cp313/bin/python
          manylinux: 2014
          target: x86_64

      - name: Install CPU wheel and run pack export tests
        run: |
          WHEEL=$(python - <<'PY'
          import glob
          import sys

          tag = f"cp{sys.version_info.major}{sys.version_info.minor}"
          wheels = sorted(glob.glob(f"target/wheels/warp_md-*-{tag}-{tag}-*.whl"))
          if not wheels:
              raise SystemExit(f"no wheel for {tag}")
          print(wheels[0])
          PY
          )
          python -m pip install "$WHEEL"
          python -m pytest python/warp_md/tests/test_pack.py

      - name: Build CPU sdist
        run: maturin sdist

      - name: Publish CPU package to PyPI (warp-md)
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: target/wheels

  build-cuda:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Resolve release version
        id: relver
        run: |
          TAG="${{ inputs.tag }}"
          if [ -z "$TAG" ]; then
            TAG="${GITHUB_REF_NAME}"
          fi
          VERSION="${TAG#v}"
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"

      - name: Update version files
        env:
          RELEASE_VERSION: ${{ steps.relver.outputs.version }}
        run: |
          python - <<'PY'
          import os
          import re
          from pathlib import Path

          version = os.environ["RELEASE_VERSION"]

          def update(path: Path) -> None:
            text = path.read_text()
            text = re.sub(r'(?m)^version = ".*?"$', f'version = "{version}"', text)
            path.write_text(text)

          update(Path("pyproject.toml"))
          for cargo in Path("crates").rglob("Cargo.toml"):
            update(cargo)
          PY

      - name: Switch package name to warp-md-cuda
        run: |
          python - <<'PY'
          from pathlib import Path
          path = Path("pyproject.toml")
          data = path.read_text()
          data = data.replace('name = "warp-md"', 'name = "warp-md-cuda"')
          path.write_text(data)
          PY

      - name: Build CUDA wheels (manylinux_2_28)
        uses: PyO3/maturin-action@v1
        env:
          CUDA_HOME: /usr/local/cuda
          PATH: /usr/local/cuda/bin:/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin
          PYO3_USE_ABI3_FORWARD_COMPATIBILITY: "1"
        with:
          command: build
          docker-options: >-
            -e PYO3_USE_ABI3_FORWARD_COMPATIBILITY=1
          args: >-
            --release --features cuda
            --interpreter /opt/python/cp38-cp38/bin/python
            --interpreter /opt/python/cp39-cp39/bin/python
            --interpreter /opt/python/cp310-cp310/bin/python
            --interpreter /opt/python/cp311-cp311/bin/python
            --interpreter /opt/python/cp312-cp312/bin/python
            --interpreter /opt/python/cp313-cp313/bin/python
          manylinux: 2_28
          before-script-linux: |
            set -eux
            yum -y install dnf-plugins-core
            dnf config-manager --add-repo https://developer.download.nvidia.com/compute/cuda/repos/rhel8/x86_64/cuda-rhel8.repo
            dnf clean expire-cache
            dnf -y install cuda-toolkit-12-4
            CUDA_DIR="$(ls -d /usr/local/cuda-* | sort -V | tail -1)"
            ln -sfn "$CUDA_DIR" /usr/local/cuda

      - name: Upload CUDA wheels
        uses: actions/upload-artifact@v4
        with:
          name: cuda-wheels
          path: target/wheels

  publish-cuda:
    runs-on: ubuntu-latest
    needs: build-cuda
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 1
          ref: ${{ github.ref }}

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Download CUDA wheels
        uses: actions/download-artifact@v4
        with:
          name: cuda-wheels
          path: target/wheels

      - name: Install CUDA wheel and run pack export tests
        run: |
          python -m pip install --upgrade pip
          python -m pip install pytest
          WHEEL=$(python - <<'PY'
          import glob
          import sys

          tag = f"cp{sys.version_info.major}{sys.version_info.minor}"
          wheels = sorted(glob.glob(f"target/wheels/warp_md_cuda-*-{tag}-{tag}-*.whl"))
          if not wheels:
              raise SystemExit(f"no wheel for {tag}")
          print(wheels[0])
          PY
          )
          python -m pip install "$WHEEL"
          python -m pytest python/warp_md/tests/test_pack.py

      - name: Publish CUDA package to PyPI (warp-md-cuda)
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: target/wheels

  release-notes:
    runs-on: ubuntu-latest
    needs: [publish-cpu, publish-cuda]
    steps:
      - name: Create GitHub Release Notes
        uses: softprops/action-gh-release@v2
        with:
          generate_release_notes: true
          tag_name: ${{ inputs.tag || github.ref_name }}
